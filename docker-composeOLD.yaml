version: "3.8"



services:
  transcription:
    container_name: transcription
    hostname: transcription
    networks:
      - backnet
    build:
      context: ./transcription
      dockerfile: Dockerfile
    image: translator-transcription
    ports:
      - "2700:2700"
    depends_on:
      transcription_redis:
        condition: service_healthy
      translation:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure
    environment:
      - TRANSCRIPTION_DEBUGMODE=True
      - TRANSLATION_HOST=translation
      - TRANSLATION_PORT=5000
      - TRANSLATION_HOST=rabbitmq
      - TRANSLATION_PORT=5672
      - REDIS_HOST=transcription_redis
      - REDIS_PORT=6379
      - TRANSCRIPTION_PORT=2700
      - VOSK_MODEL_PATHS={"en":"models/vosk-model-en-us-0.22","de":"models/vosk-model-de-0.21"}
  
  transcription_redis:
    container_name: transcription_redis
    hostname: transcription_redis
    networks:
      - backnet
    image: redis
    ports:
      - "6379:6379"
    restart: on-failure
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 30s
      timeout: 5s
      retries: 2
      start_period: 1m
      start_interval: 5s
    volumes:
      - transcription_db:/data

  translation:
    container_name: translation
    hostname: translation
    networks:
      - backnet
    build:
      context: ./translation
      dockerfile: Dockerfile
    image: translator-translation
    ports:
      - "5000:5000"
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", "./venv/bin/python scripts/healthcheck.py"]
      interval: 30s
      timeout: 5s
      retries: 2
      start_period: 1m
      start_interval: 5s
    environment:
      - LT_DISABLE_FILES_TRANSLATION=true
      - LT_DISABLE_WEB_UI=true
      - LT_UPDATE_MODELS=true
      - LT_HOST=0.0.0.0
      - LT_LOAD_ONLY=en,de
      - LT_DEBUG=false
    #  - TRANSCRIPTION_DEBUGMODE=False


  rabbitmq:
    container_name: rabbitmq
    hostname: rabbitmq
    networks:
      - backnet
    image: rabbitmq
    ports:
      - "5672:5672"
    restart: on-failure
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 1m
      start_interval: 5s


volumes:
  transcription_db:
    name: translator_transcription_db


networks:
  backnet:
    name: backnet



